# AutoZig å®‰å…¨æœ€ä½³å®è·µæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäºå¯¹ AutoZig çš„å…¨é¢å®‰å…¨å®¡è®¡ï¼Œæ€»ç»“äº†åœ¨ä½¿ç”¨ AutoZig è¿›è¡Œ Rust-Zig FFI å¼€å‘æ—¶åº”éµå¾ªçš„å®‰å…¨æœ€ä½³å®è·µã€‚

**å®¡è®¡ç»“è®º**: AutoZig æœ¬èº«ä¸ä¼šå¼•å…¥æ–°çš„å®‰å…¨æ¼æ´ç±»å‹ï¼Œä½†å®ƒä¼šå°†ä¼ ç»Ÿ FFI çš„é£é™©è½¬ç§»åˆ° Zig ä»£ç è´¨é‡ä¸Šã€‚åªè¦ Zig ä»£ç éµå¾ªæœ€ä½³å®è·µï¼Œæ•´ä½“å®‰å…¨æ€§å¯ä»¥**é«˜äº**ä¼ ç»Ÿ unsafe Rust FFIã€‚

## ğŸ¯ å…³é”®å‘ç°

### AutoZig çš„å®‰å…¨ä¼˜åŠ¿

1. **ç¼–è¯‘æœŸæ£€æŸ¥**: IDL é©±åŠ¨çš„ç±»å‹ç³»ç»Ÿç¡®ä¿ FFI æ¥å£çš„ç±»å‹å®‰å…¨
2. **è‡ªåŠ¨é™çº§**: `&str`ã€`&[T]` ç­‰é«˜çº§ç±»å‹è‡ªåŠ¨è½¬æ¢ä¸ºå®‰å…¨çš„ ptr+len å½¢å¼
3. **é›¶ unsafeï¼ˆç”¨æˆ·ä»£ç ï¼‰**: æ‰€æœ‰ unsafe æ“ä½œå°è£…åœ¨ç”Ÿæˆçš„ä»£ç ä¸­
4. **ç»“æ„åŒ–é”™è¯¯å¤„ç†**: ç¼–è¯‘æœŸæ•è·å¤§éƒ¨åˆ† ABI ä¸åŒ¹é…é—®é¢˜

### æ½œåœ¨é£é™©ç‚¹

AutoZig ä¸æ‰€æœ‰ FFI æ¡†æ¶å…±äº«ä»¥ä¸‹å¸¸è§é£é™©ï¼š

| é£é™©ç±»å‹ | ä¸¥é‡æ€§ | å‘ç”Ÿæ¦‚ç‡ | é˜²æŠ¤æªæ–½ |
|---------|--------|----------|----------|
| Use-After-Free | æé«˜ | é«˜ | âœ… ç”Ÿå‘½å‘¨æœŸçº¦æŸ + æ–‡æ¡£è§„èŒƒ |
| Buffer Overflow | é«˜ | ä¸­ | âœ… Zig åˆ‡ç‰‡è¾¹ç•Œæ£€æŸ¥ï¼ˆDebugï¼‰ |
| ABI Mismatch | é«˜ | ä½ | âœ… `#[repr(C)]` + `extern struct` |
| Data Race | é«˜ | ä¸­ | âœ… Rust å¹¶å‘åŸè¯­ç®¡ç† |

## âœ… æœ€ä½³å®è·µæ¸…å•

### 1. ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### âœ… DOï¼ˆæ¨èï¼‰

```rust
// âœ… ç«‹å³ä½¿ç”¨å¹¶è¿”å›ï¼Œä¸ä¿å­˜å¼•ç”¨
fn process_data(data: &[u8]) -> u64 {
    zig_process(data)  // Zig åœ¨è°ƒç”¨æœŸé—´å®Œæˆæ‰€æœ‰æ“ä½œ
}

// âœ… ä½¿ç”¨ Arc/Box ç®¡ç†è·¨çº¿ç¨‹æ•°æ®
fn process_async(data: Arc<Vec<u8>>) {
    thread::spawn(move || {
        zig_process(&data);
    });
}
```

#### âŒ DON'Tï¼ˆé¿å…ï¼‰

```zig
// âŒ æ°¸è¿œä¸è¦åœ¨ Zig ä¸­ä¿å­˜ Rust ä¼ æ¥çš„æŒ‡é’ˆï¼
var global_ptr: ?[*]const u8 = null;  // å±é™©ï¼

export fn bad_save_pointer(ptr: [*]const u8, len: usize) void {
    global_ptr = ptr;  // Use-After-Free é£é™©
}
```

**åŸå› **: Rust çš„å€Ÿç”¨æ£€æŸ¥å™¨æ— æ³•è¿½è¸ª Zig å†…éƒ¨çš„æŒ‡é’ˆæ“ä½œï¼Œä¸€æ—¦ Rust ä¾§ç”Ÿå‘½å‘¨æœŸç»“æŸï¼ŒZig ä¿å­˜çš„æŒ‡é’ˆå°±ä¼šæ‚¬å‚ã€‚

### 2. è¾¹ç•Œæ£€æŸ¥

#### âœ… DOï¼ˆæ¨èï¼‰

```zig
// âœ… ä½¿ç”¨åˆ‡ç‰‡è¯­æ³•ï¼Œè‡ªåŠ¨è¾¹ç•Œæ£€æŸ¥ï¼ˆDebug æ¨¡å¼ï¼‰
export fn safe_process(ptr: [*]const u8, len: usize) void {
    const slice = ptr[0..len];  // è½¬æ¢ä¸ºåˆ‡ç‰‡
    for (slice) |byte| {
        // å®‰å…¨è®¿é—®
    }
}

// âœ… æ˜¾å¼è¾¹ç•Œæ£€æŸ¥
export fn safe_get(ptr: [*]const u8, len: usize, index: usize) i32 {
    if (index >= len) {
        return -1;  // è¿”å›é”™è¯¯ç 
    }
    return @as(i32, ptr[index]);
}
```

#### âŒ DON'Tï¼ˆé¿å…ï¼‰

```zig
// âŒ ç›´æ¥ä½¿ç”¨åŸå§‹æŒ‡é’ˆ + æœªæ£€æŸ¥çš„ç´¢å¼•
export fn unsafe_access(ptr: [*]u8, len: usize) void {
    var i: usize = 0;
    while (i < len + 10) : (i += 1) {  // è¶Šç•Œï¼
        ptr[i] = 0xFF;
    }
}
```

### 3. ç»“æ„ä½“å¸ƒå±€

#### âœ… DOï¼ˆæ¨èï¼‰

```rust
// âœ… Rust ä¾§ï¼šå§‹ç»ˆä½¿ç”¨ #[repr(C)]
#[repr(C)]
struct Point {
    x: i32,
    y: i32,
}
```

```zig
// âœ… Zig ä¾§ï¼šä½¿ç”¨ extern struct ç¡®ä¿ C ABI
const Point = extern struct {
    x: i32,
    y: i32,
};
```

### 4. çº¿ç¨‹å®‰å…¨

#### âœ… DOï¼ˆæ¨èï¼‰

```rust
// âœ… ç”¨ Rust çš„å¹¶å‘åŸè¯­ç®¡ç†å…±äº«çŠ¶æ€
use std::sync::{Arc, Mutex};

let data = Arc::new(Mutex::new(vec![0u8; 100]));
let data_clone = data.clone();

thread::spawn(move || {
    let mut d = data_clone.lock().unwrap();
    zig_process(&mut d);
});
```

## ğŸ§ª æµ‹è¯•ä¸éªŒè¯

### æ¨èçš„æµ‹è¯•å·¥å…·é“¾

1. **AddressSanitizer (ASan)** - å†…å­˜é”™è¯¯æ£€æµ‹

```bash
RUSTFLAGS="-Z sanitizer=address" cargo +nightly run --release
```

2. **ThreadSanitizer (TSan)** - æ•°æ®ç«äº‰æ£€æµ‹

```bash
RUSTFLAGS="-Z sanitizer=thread" cargo +nightly run
```

3. **Valgrind** - ä¼ ç»Ÿå†…å­˜è°ƒè¯•

```bash
valgrind --leak-check=full target/debug/your-app
```

### é›†æˆæµ‹è¯•ç¤ºä¾‹

å‚è€ƒ `examples/security_tests` é¡¹ç›®ï¼Œå®ƒå±•ç¤ºäº†ï¼š

- âœ… å®‰å…¨çš„è¾¹ç•Œæ£€æŸ¥æ¨¡å¼
- âœ… æ­£ç¡®çš„ç»“æ„ä½“ ABI ä½¿ç”¨
- âœ… å®‰å…¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
- ğŸ“ æ½œåœ¨é£é™©æ¨¡å¼çš„æ–‡æ¡£è¯´æ˜

## ğŸ“Š å®‰å…¨å®¡è®¡æŠ¥å‘Š

åŸºäº `examples/security_tests` çš„å®Œæ•´æµ‹è¯•ï¼š

| æµ‹è¯•é¡¹ | ç»“æœ | è¯´æ˜ |
|--------|------|------|
| ç¼“å†²åŒºæ“ä½œ | âœ… é€šè¿‡ | Zig åˆ‡ç‰‡è¾¹ç•Œæ£€æŸ¥æœ‰æ•ˆ |
| è¾¹ç•Œæ£€æŸ¥ | âœ… é€šè¿‡ | è¶Šç•Œè¿”å›é”™è¯¯ç ï¼Œä¸å´©æºƒ |
| ç»“æ„ä½“ ABI | âœ… é€šè¿‡ | `#[repr(C)]` ç¡®ä¿å¸ƒå±€ä¸€è‡´ |
| å†…å­˜æ³„æ¼ | âœ… æ— æ³„æ¼ | é™æ€é“¾æ¥ï¼Œæ— åŠ¨æ€åˆ†é… |

**æµ‹è¯•è¦†ç›–**: æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ3/3ï¼‰ï¼Œæ— å†…å­˜é”™è¯¯ã€æ— ç«äº‰æ¡ä»¶ã€‚

## ğŸš¨ å¸¸è§é™·é˜±

### é™·é˜± 1: å‡è®¾ Zig æŒ‡é’ˆæ°¸ä¹…æœ‰æ•ˆ

```rust
// âŒ é”™è¯¯è®¤çŸ¥ï¼šZig å¯ä»¥ä¿å­˜è¿™ä¸ªæŒ‡é’ˆ
let mut data = vec![1, 2, 3];
zig_save(&mut data);
drop(data);  // ğŸ’¥ Zig ä¿å­˜çš„æŒ‡é’ˆç°åœ¨æ‚¬å‚ï¼
```

### é™·é˜± 2: å¿½ç•¥ Zig çš„ C ABI è¦æ±‚

```zig
// âŒ ä½¿ç”¨ Zig åŸç”Ÿ structï¼ˆé externï¼‰
const Point = struct {  // å¸ƒå±€ä¸ç¡®å®šï¼
    x: i32,
    y: i32,
};
```

## ğŸ“ å­¦ä¹ èµ„æº

- [Rust FFI æ–‡æ¡£](https://doc.rust-lang.org/nomicon/ffi.html)
- [Zig C Interop](https://ziglang.org/documentation/master/#C)
- [AddressSanitizer æ–‡æ¡£](https://clang.llvm.org/docs/AddressSanitizer.html)
- [AutoZig ç¤ºä¾‹](examples/)

## ğŸ“ æ€»ç»“

AutoZig é€šè¿‡ä»¥ä¸‹æ–¹å¼æå‡å®‰å…¨æ€§ï¼š

1. **ç¼–è¯‘æœŸä¿éšœ**: ç±»å‹ç³»ç»Ÿ + IDL é©±åŠ¨ç”Ÿæˆ
2. **è‡ªåŠ¨åŒ–**: å‡å°‘æ‰‹åŠ¨ unsafe ä»£ç 
3. **å·¥å…·å‹å¥½**: å…¼å®¹ ASan/TSan/Valgrind
4. **æ–‡æ¡£è§„èŒƒ**: æ¸…æ™°çš„æœ€ä½³å®è·µæŒ‡å—

**å…³é”®åŸåˆ™**: ä¿¡ä»»è½¬ç§» - AutoZig å°† FFI å®‰å…¨ä»"Rust unsafe ä»£ç è´¨é‡"è½¬ç§»åˆ°"Zig ä»£ç è´¨é‡"ã€‚éµå¾ªæœ¬æŒ‡å—ï¼Œå¯ä»¥å®ç°å®‰å…¨ã€é«˜æ•ˆçš„è·¨è¯­è¨€äº’æ“ä½œã€‚

---

*æœ€åæ›´æ–°: 2026-01-05*