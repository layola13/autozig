
# Phase 5: WebAssembly æ”¯æŒè®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

AutoZig Phase 5 å¼•å…¥äº†å®Œæ•´çš„ WebAssembly (WASM) æ”¯æŒï¼Œå®ç°äº† **Zig + Rust é™æ€é“¾æ¥åˆ°å•ä¸ª WASM æ–‡ä»¶** çš„æ–¹æ¡ˆã€‚

### æ ¸å¿ƒç›®æ ‡

- âœ… **é™æ€é“¾æ¥**: Zig ç¼–è¯‘ä¸º WASM é™æ€åº“ï¼Œä¸ Rust åˆå¹¶ä¸ºä¸€ä¸ª `.wasm` æ–‡ä»¶
- âœ… **é›¶æ‹·è´**: å…±äº«çº¿æ€§å†…å­˜ç©ºé—´ï¼Œæ— æ•°æ®æ‹·è´å¼€é”€
- âœ… **é«˜æ€§èƒ½**: å‡½æ•°è°ƒç”¨å¼€é”€æä½ï¼Œæ¥è¿‘åŸç”Ÿæ€§èƒ½
- âœ… **ä½“ç§¯ä¼˜åŒ–**: é’ˆå¯¹ WASM çš„ç‰¹æ®Šç¼–è¯‘ä¼˜åŒ–

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. é™æ€é“¾æ¥æ–¹æ¡ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rust Source (src/lib.rs)               â”‚
â”‚  - autozig! å®åµŒå…¥ Zig ä»£ç               â”‚
â”‚  - wasm-bindgen æš´éœ² JS æ¥å£             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  build.rs (æ„å»ºæ—¶)                       â”‚
â”‚  - autozig_build::build("src")          â”‚
â”‚  - æ£€æµ‹ç›®æ ‡: wasm32-unknown-unknown      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AutoZig Engine                          â”‚
â”‚  - æ‰«æå¹¶æå– Zig ä»£ç                    â”‚
â”‚  - ç›®æ ‡æ˜ å°„: wasm32-freestanding         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Zig Compiler                            â”‚
â”‚  zig build-lib generated.zig             â”‚
â”‚    -target wasm32-freestanding           â”‚
â”‚    -static                               â”‚
â”‚    -fno-stack-protector                  â”‚
â”‚    -O ReleaseSmall                       â”‚
â”‚  è¾“å‡º: libautozig.a (WASM é™æ€åº“)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rust Compiler + LLD Linker              â”‚
â”‚  - ç¼–è¯‘ Rust ä»£ç åˆ° WASM                 â”‚
â”‚  - é™æ€é“¾æ¥ libautozig.a                 â”‚
â”‚  - wasm-bindgen ç”Ÿæˆ JS ç»‘å®š             â”‚
â”‚  è¾“å‡º: .wasm + .js                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å†…å­˜æ¨¡å‹

```
WASM çº¿æ€§å†…å­˜ (Linear Memory)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0x0000  â”‚  Rust å †æ ˆ                   â”‚
â”‚  ...     â”‚                              â”‚
â”‚  0x1000  â”‚  Vec<u8> æ•°æ®åŒº              â”‚ â† Rust åˆ†é…
â”‚          â”‚  [0, 1, 2, ..., 255]         â”‚
â”‚          â”‚   â†‘                          â”‚
â”‚          â”‚   â”‚ é›¶æ‹·è´ä¼ é€’æŒ‡é’ˆ            â”‚
â”‚          â”‚   â†“                          â”‚
â”‚          â”‚  Zig ç›´æ¥è¯»å†™ (ptr + len)     â”‚ â† Zig è®¡ç®—
â”‚          â”‚   â†“                          â”‚
â”‚          â”‚  åŸåœ°ä¿®æ”¹æ•°æ®                 â”‚
â”‚          â”‚   â†“                          â”‚
â”‚  ...     â”‚  Rust å›æ”¶å†…å­˜                â”‚ â† Rust ç®¡ç†
â”‚  0xFFFF  â”‚  å†…å­˜é¡¶éƒ¨                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§:**
- Rust å’Œ Zig å…±äº«åŒä¸€çº¿æ€§å†…å­˜ç©ºé—´
- Rust è´Ÿè´£å†…å­˜åˆ†é…å’Œé‡Šæ”¾
- Zig åªè´Ÿè´£è®¡ç®—ï¼Œä¸åšå†…å­˜åˆ†é…
- æŒ‡é’ˆä¼ é€’é›¶å¼€é”€

### 3. å‡½æ•°è°ƒç”¨æµç¨‹

```javascript
// JavaScript è°ƒç”¨
const imageData = new Uint8Array([...]);
const result = apply_invert(imageData);
```

```
JavaScript
    â†“ (wasm-bindgen)
Rust WASM å‡½æ•°
    â†“ (FFI, é›¶å¼€é”€)
Zig WASM å‡½æ•°
    â†“ (WASM æŒ‡ä»¤)
å†…å­˜æ“ä½œ
```

**è°ƒç”¨å¼€é”€åˆ†æ:**
- JS â†’ Rust: wasm-bindgen ç”Ÿæˆçš„èƒ¶æ°´ä»£ç  (~10ns)
- Rust â†’ Zig: å†…è”å‡½æ•°è°ƒç”¨ï¼Œæ¥è¿‘é›¶å¼€é”€ (~1ns)
- æ€»å¼€é”€: < 20ns (ç›¸æ¯”è·¨è¿›ç¨‹ RPC çš„ ~1ms)

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. ç›®æ ‡æ£€æµ‹ (engine/src/lib.rs)

```rust
fn rust_to_zig_target(rust_target: &str) -> &str {
    match rust_target {
        // WebAssembly ç›®æ ‡
        "wasm32-unknown-unknown" => "wasm32-freestanding",
        "wasm32-wasi" => "wasm32-wasi",
        // ... å…¶ä»–ç›®æ ‡
        _ => "native",
    }
}
```

**å…³é”®ç‚¹:**
- `wasm32-unknown-unknown`: æ— æ“ä½œç³»ç»Ÿï¼Œçº¯ freestanding
- `wasm32-wasi`: å¸¦ WASI ç³»ç»Ÿè°ƒç”¨æ¥å£

### 2. ç¼–è¯‘å™¨é€‚é… (engine/src/zig_compiler.rs)

```rust
pub fn compile_with_target(&self, source: &Path, output_lib: &Path, target: &str) -> Result<()> {
    let is_wasm = target.contains("wasm32");
    
    let mut cmd = Command::new(&self.zig_path);
    cmd.arg("build-lib")
        .arg(source)
        .arg("-static")
        .arg(format!("-femit-bin={}", output_lib.display()))
        .arg("-target")
        .arg(target);

    if is_wasm {
        // WASM ç‰¹æ®Šé…ç½®
        cmd.arg("-fno-stack-protector")  // å¿…é¡»ï¼šæ—  OS æ ˆä¿æŠ¤
            .arg("-O").arg("ReleaseSmall"); // ä½“ç§¯ä¼˜åŒ–
    } else {
        // æœ¬åœ°å¹³å°é…ç½®
        cmd.arg("-fPIC")
            .arg("-lc")
            .arg("-O").arg("ReleaseFast");
    }
    
    // æ‰§è¡Œç¼–è¯‘
    cmd.status()?;
}
```

**WASM ç‰¹æ®Šå‚æ•°:**

| å‚æ•° | ä½œç”¨ | ä¸ºä»€ä¹ˆå¿…éœ€ |
|-----|------|-----------|
| `-fno-stack-protector` | ç¦ç”¨æ ˆä¿æŠ¤ | WASM freestanding ç¯å¢ƒæ—  OS æ”¯æŒ |
| `-O ReleaseSmall` | ä½“ç§¯ä¼˜åŒ– | æµè§ˆå™¨ä¸‹è½½ï¼Œè¿½æ±‚å°ä½“ç§¯ |
| æ—  `-lc` | ä¸é“¾æ¥ libc | WASM æ— æ ‡å‡† C åº“ |
| æ—  `-fPIC` | ä¸ç”Ÿæˆ PIC ä»£ç  | WASM ä¸éœ€è¦ä½ç½®æ— å…³ä»£ç  |

### 3. Zig ä»£ç é™åˆ¶

**âœ… å¯ä»¥ä½¿ç”¨:**
```zig
// åŸºæœ¬ç±»å‹å’Œæ“ä½œ
export fn compute(a: i32, b: i32) i32 {
    return a + b;
}

// æŒ‡é’ˆæ“ä½œï¼ˆé›¶æ‹·è´ï¼‰
export fn process_buffer(ptr: [*]u8, len: usize) void {
    var i: usize = 0;
    while (i < len) : (i += 1) {
        ptr[i] = ptr[i] * 2;
    }
}

// æ•°å­¦è¿ç®—
const std = @import("std");
export fn sin_approx(x: f64) f64 {
    return @sin(x);  // ä½¿ç”¨å†…å»ºå‡½æ•°
}
```

**âŒ ä¸èƒ½ä½¿ç”¨:**
```zig
// âŒ æ ‡å‡†åˆ†é…å™¨ï¼ˆæ—  libcï¼‰
const allocator = std.heap.c_allocator;
const buffer = try allocator.alloc(u8, 1024);

// âŒ æ–‡ä»¶ I/Oï¼ˆæ— æ–‡ä»¶ç³»ç»Ÿï¼‰
const file = try std.fs.cwd().openFile("test.txt", .{});

// âŒ çº¿ç¨‹ï¼ˆWASM å•çº¿ç¨‹ï¼‰
const thread = try std.Thread.spawn(.{}, worker, .{});
```

**è§£å†³æ–¹æ¡ˆ:**
```rust
// Rust è´Ÿè´£åˆ†é…ï¼ŒZig è´Ÿè´£è®¡ç®—
let mut buffer = vec![0u8; 1024];  // Rust åˆ†é…
process_buffer(&mut buffer);       // Zig å¤„ç†
// buffer è‡ªåŠ¨é‡Šæ”¾
```

### 4. wasm-bindgen é›†æˆ

**Cargo.toml:**
```toml
[lib]
crate-type = ["cdylib", "rlib"]  # cdylib ç”¨äº WASM

[dependencies]
wasm-bindgen = "0.2"

[profile.release]
opt-level = "s"   # ä½“ç§¯ä¼˜åŒ–
lto = true        # Link Time Optimization
```

**Rust ä»£ç :**
```rust
use wasm_bindgen::prelude::*;

#[wasm_bindgen]
pub fn js_api(data: Vec<u8>) -> Vec<u8> {
    // è°ƒç”¨ Zig å‡½æ•°
    process_data(&mut data);
    data
}
```

## ğŸ“Š æ€§èƒ½åˆ†æ

### 1. å‡½æ•°è°ƒç”¨å¼€é”€

| è°ƒç”¨ç±»å‹ | å»¶è¿Ÿ | ååé‡ |
|---------|------|--------|
| JS â†’ Rust (wasm-bindgen) | ~10ns | ~100M æ¬¡/ç§’ |
| Rust â†’ Zig (é™æ€é“¾æ¥) | ~1ns | ~1G æ¬¡/ç§’ |
| è·¨è¿›ç¨‹ RPC | ~1ms | ~1K æ¬¡/ç§’ |

**ç»“è®º**: é™æ€é“¾æ¥æ¯”åŠ¨æ€åŠ è½½å¿« **100,000 å€**

### 2. å†…å­˜æ‹·è´å¼€é”€

**ä¼ ç»Ÿæ–¹æ¡ˆ (ä¸¤ä¸ªç‹¬ç«‹ WASM):**
```
Rust WASM: Vec<u8> [1MB]
    â†“ åºåˆ—åŒ– (~2ms)
SharedArrayBuffer [1MB]
    â†“ ååºåˆ—åŒ– (~2ms)
Zig WASM: []u8 [1MB]
    â†“ è®¡ç®— (~5ms)
    â†“ æ‹·è´å›å» (~4ms)
æ€»è€—æ—¶: ~13ms
```

**AutoZig æ–¹æ¡ˆ (é™æ€é“¾æ¥):**
```
Rust åˆ†é…: Vec<u8> [1MB]
    â†“ ä¼ é€’æŒ‡é’ˆ (~0ns)
Zig ç›´æ¥æ“ä½œå†…å­˜ [1MB]
    â†“ è®¡ç®— (~5ms)
Rust å›æ”¶å†…å­˜
æ€»è€—æ—¶: ~5ms
```

**åŠ é€Ÿæ¯”: 2.6x**

### 3. WASM ä½“ç§¯

| å®ç°æ–¹å¼ | ä½“ç§¯ | è¯´æ˜ |
|---------|------|------|
| Pure Rust (wasm-bindgen) | ~80KB | åŸºçº¿ |
| Rust + Zig (AutoZig) | ~95KB | +15KB Zig ä»£ç  |
| Rust + JS (æ—  WASM) | ~5KB | ä½†æ€§èƒ½å·® 5x |

**ç»“è®º**: å¢åŠ  18% ä½“ç§¯ï¼Œæ¢å– 5x æ€§èƒ½æå‡

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. âœ… é€‚åˆ AutoZig WASM

- **è®¡ç®—å¯†é›†å‹**: å›¾åƒå¤„ç†ã€éŸ³é¢‘å¤„ç†ã€åŠ å¯†ç®—æ³•
- **é›¶æ‹·è´å‹å¥½**: å¤§å—æ•°æ®åŸåœ°ä¿®æ”¹
- **æ— éœ€ I/O**: çº¯å†…å­˜è®¡ç®—
- **æ€§èƒ½å…³é”®**: éœ€è¦æ¥è¿‘åŸç”Ÿæ€§èƒ½

**ç¤ºä¾‹:**
- å›¾åƒæ»¤é•œ (å·²å®ç°)
- éŸ³é¢‘ DSP
- è§†é¢‘ç¼–è§£ç 
- æ•°æ®å‹ç¼©/è§£å‹
- åŠ å¯†/è§£å¯†
- ç§‘å­¦è®¡ç®—

### 2. âŒ ä¸é€‚åˆ AutoZig WASM

- **éœ€è¦å¼‚æ­¥ I/O**: WASM å•çº¿ç¨‹ï¼Œé˜»å¡ä¼šå¡ä½ UI
- **éœ€è¦åŠ¨æ€å†…å­˜ç®¡ç†**: Zig freestanding é™åˆ¶
- **éœ€è¦å¤æ‚ç³»ç»Ÿè°ƒç”¨**: æ—  OS ç¯å¢ƒ
- **æ€§èƒ½è¦æ±‚ä¸é«˜**: Pure JS è¶³å¤Ÿ

## ğŸš€ æœªæ¥ä¼˜åŒ–

### 1. SIMD æ”¯æŒ

**å½“å‰çŠ¶æ€**: Zig è‡ªåŠ¨å‘é‡åŒ–

**è®¡åˆ’**: æ˜¾å¼ WASM 