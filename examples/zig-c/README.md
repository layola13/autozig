# Zig-C äº’æ“ä½œç¤ºä¾‹

æœ¬ç¤ºä¾‹å±•ç¤ºäº† **Rust â†’ Zig â†’ C** çš„ä¸‰å±‚è°ƒç”¨é“¾ï¼Œæ¼”ç¤ºå¦‚ä½•é€šè¿‡ autozig è®© Rust ä»£ç è°ƒç”¨ Zig åŒ…è£…çš„ C å‡½æ•°ã€‚

## ğŸ“‹ é¡¹ç›®ç»“æ„

```
zig-c/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs       # Rust ä¸»ç¨‹åºï¼ˆä½¿ç”¨ autozig å®ï¼‰
â”‚   â”œâ”€â”€ wrapper.zig   # Zig åŒ…è£…å±‚ï¼ˆè°ƒç”¨ C å¹¶æ·»åŠ æ–°åŠŸèƒ½ï¼‰
â”‚   â””â”€â”€ math.c        # C åŸºç¡€è¿ç®—åº“
â”œâ”€â”€ build.rs          # æ„å»ºè„šæœ¬ï¼ˆç¼–è¯‘ Zig å’Œ C ä»£ç ï¼‰
â””â”€â”€ Cargo.toml
```

## ğŸ”— è°ƒç”¨é“¾æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Rust å±‚                             â”‚
â”‚  - ä½¿ç”¨ zig! å®å£°æ˜ Zig å‡½æ•°                             â”‚
â”‚  - è‡ªåŠ¨ç”Ÿæˆç±»å‹å®‰å…¨çš„ FFI ç»‘å®š                           â”‚
â”‚  - æ™ºèƒ½é™çº§ï¼š&[i32] â†’ ptr+len, &str â†’ ptr+len            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ FFI è°ƒç”¨
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Zig å±‚                              â”‚
â”‚  - åŒ…è£… C å‡½æ•°ï¼ˆadd, multiply, sum_array, etc.ï¼‰        â”‚
â”‚  - æ·»åŠ å¢å¼ºåŠŸèƒ½ï¼ˆpower, averageï¼‰                        â”‚
â”‚  - å¤„ç† FFI ç±»å‹è½¬æ¢                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ extern "c" è°ƒç”¨
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       C å±‚                               â”‚
â”‚  - æä¾›åŸºç¡€è¿ç®—å®ç°                                      â”‚
â”‚  - c_add(), c_multiply(), c_sum_array(), c_string_length()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ åŠŸèƒ½æ¼”ç¤º

### 1. ç›´æ¥åŒ…è£… C å‡½æ•°

**C å®ç°** (`math.c`):
```c
int c_add(int a, int b) {
    return a + b;
}
```

**Zig åŒ…è£…** (`wrapper.zig`):
```zig
extern "c" fn c_add(a: i32, b: i32) i32;

export fn add(a: i32, b: i32) i32 {
    return c_add(a, b);
}
```

**Rust è°ƒç”¨** (`main.rs`):
```rust
zig! {
    fn add(a: i32, b: i32) -> i32;
}

let result = add(10, 20); // 30
```

### 2. Zig å¢å¼ºåŠŸèƒ½ï¼ˆç»„åˆ C å‡½æ•°ï¼‰

**Zig å®ç°**ï¼šä½¿ç”¨ C çš„ `multiply` å®ç°å¹‚è¿ç®—
```zig
export fn power(base: i32, exp: u32) i32 {
    var result: i32 = 1;
    var i: u32 = 0;
    while (i < exp) : (i += 1) {
        result = c_multiply(result, base);
    }
    return result;
}
```

**Rust è°ƒç”¨**ï¼š
```rust
let result = power(2, 10); // 1024
let result = power(5, 3);  // 125
```

### 3. æ™ºèƒ½é™çº§ï¼šåˆ‡ç‰‡ `&[i32]` â†’ `ptr + len`

**Zig å®ç°**ï¼š
```zig
export fn sum_array(arr_ptr: [*c]const i32, arr_len: usize) i32 {
    if (arr_len == 0) return 0;
    return c_sum_array(arr_ptr, @intCast(arr_len));
}
```

**Rust è°ƒç”¨**ï¼šè‡ªåŠ¨é™çº§ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ é€’æŒ‡é’ˆå’Œé•¿åº¦
```rust
let numbers = [1, 2, 3, 4, 5];
let sum = sum_array(&numbers); // 15ï¼ˆè‡ªåŠ¨è½¬æ¢ä¸º ptr + lenï¼‰
```

### 4. æ™ºèƒ½é™çº§ï¼šå­—ç¬¦ä¸² `&str` â†’ `ptr + len`

**Zig å®ç°**ï¼šç›´æ¥ä½¿ç”¨ Rust ä¼ å…¥çš„é•¿åº¦
```zig
export fn string_length(str_ptr: [*c]const u8, str_len: usize) u32 {
    return @intCast(str_len);
}
```

**Rust è°ƒç”¨**ï¼š
```rust
let text = "Hello from Rust!";
let len = string_length(text); // 16ï¼ˆè‡ªåŠ¨è½¬æ¢ä¸º ptr + lenï¼‰
```

### 5. æ··åˆåŠŸèƒ½ï¼šC æ±‚å’Œ + Zig æµ®ç‚¹è®¡ç®—

**Zig å®ç°**ï¼šç»“åˆ C æ±‚å’Œä¸ Zig æµ®ç‚¹é™¤æ³•
```zig
export fn average(arr_ptr: [*c]const i32, arr_len: usize) f64 {
    if (arr_len == 0) return 0.0;
    
    const sum = c_sum_array(arr_ptr, @intCast(arr_len));
    return @as(f64, @floatFromInt(sum)) / @as(f64, @floatFromInt(arr_len));
}
```

**Rust è°ƒç”¨**ï¼š
```rust
let numbers = [1, 2, 3, 4, 5];
let avg = average(&numbers); // 3.0
```

## ğŸ”§ æ„å»ºé…ç½®

### `build.rs` å…³é”®é…ç½®

```rust
fn main() {
    // 1. æŸ¥æ‰¾æ‰€æœ‰ C æºæ–‡ä»¶
    let c_files: Vec<PathBuf> = glob::glob("src/**/*.c")
        .unwrap()
        .filter_map(Result::ok)
        .collect();

    // 2. ä¼ é€’ç»™ autozigï¼ˆè‡ªåŠ¨ç¼–è¯‘ C ä»£ç ï¼‰
    autozig_gen_build::Builder::new()
        .with_c_sources(&c_files)  // å…³é”®ï¼šæ·»åŠ  C æºæ–‡ä»¶
        .build()
        .expect("Failed to build Zig code");

    // 3. ç›‘å¬æ–‡ä»¶å˜åŒ–
    println!("cargo:rerun-if-changed=src/wrapper.zig");
    println!("cargo:rerun-if-changed=src/math.c");
}
```

### Zig ä»£ç ä¸­çš„ C å‡½æ•°å£°æ˜

```zig
// å£°æ˜ C å‡½æ•°æ¥å£ï¼ˆä¸ä½¿ç”¨ @cImportï¼‰
extern "c" fn c_add(a: i32, b: i32) i32;
extern "c" fn c_multiply(a: i32, b: i32) i32;
extern "c" fn c_sum_array(arr: [*c]const i32, len: u32) i32;
extern "c" fn c_string_length(str: [*c]const u8) u32;
```

## ğŸ§ª æµ‹è¯•

è¿è¡Œå•å…ƒæµ‹è¯•ï¼š
```bash
cargo test
```

æµ‹è¯•è¦†ç›–ï¼š
- âœ… åŸºç¡€ C å‡½æ•°åŒ…è£…ï¼ˆadd, multiplyï¼‰
- âœ… Zig å¢å¼ºåŠŸèƒ½ï¼ˆpowerï¼‰
- âœ… æ•°ç»„æ™ºèƒ½é™çº§ï¼ˆ&[i32] â†’ ptr+lenï¼‰
- âœ… å­—ç¬¦ä¸²æ™ºèƒ½é™çº§ï¼ˆ&str â†’ ptr+lenï¼‰

## ğŸš€ è¿è¡Œç¤ºä¾‹

```bash
cargo run
```

é¢„æœŸè¾“å‡ºï¼š
```
=== Zig-C äº’æ“ä½œç¤ºä¾‹ ===

æ¼”ç¤ºè°ƒç”¨é“¾ï¼šRust â†’ Zig â†’ C

1. åŸºç¡€ C å‡½æ•°è°ƒç”¨:
   add(10, 20) = 30
   multiply(7, 8) = 56

2. Zig å¢å¼ºåŠŸèƒ½ï¼ˆä½¿ç”¨ C multiply å®ç°å¹‚è¿ç®—ï¼‰:
   power(2, 10) = 1024
   power(5, 3) = 125

3. æ™ºèƒ½é™çº§æµ‹è¯• - æ•°ç»„åˆ‡ç‰‡:
   æ•°ç»„: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
   sum_array(&numbers) = 55
   ï¼ˆRustçš„ &[i32] è‡ªåŠ¨è½¬æ¢ä¸º ptr + len ä¼ é€’ç»™ Zigï¼‰

4. æ™ºèƒ½é™çº§æµ‹è¯• - å­—ç¬¦ä¸²:
   å­—ç¬¦ä¸²: "Hello from Rust!"
   string_length("Hello from Rust!") = 16
   ï¼ˆRustçš„ &str è‡ªåŠ¨è½¬æ¢ä¸º ptr + len ä¼ é€’ç»™ Zigï¼‰

5. æ··åˆåŠŸèƒ½æµ‹è¯•ï¼ˆCæ±‚å’Œ + Zigæµ®ç‚¹è®¡ç®—ï¼‰:
   average(&numbers) = 5.50

=== æ¼”ç¤ºå®Œæˆ ===
```

## ğŸ“š å…³é”®è¦ç‚¹

### 1. **C ä»£ç é›†æˆ**
- åœ¨ `build.rs` ä¸­ä½¿ç”¨ `with_c_sources()` æ·»åŠ  C æºæ–‡ä»¶
- Zig é€šè¿‡ `extern "c"` å£°æ˜è°ƒç”¨ C å‡½æ•°
- autozig è‡ªåŠ¨å¤„ç†ç¼–è¯‘å’Œé“¾æ¥

### 2. **ç±»å‹å®‰å…¨**
- Rust â†’ Zigï¼šé€šè¿‡ FFI å®‰å…¨åœ°ä¼ é€’åŸºç¡€ç±»å‹
- æ™ºèƒ½é™çº§ï¼šè‡ªåŠ¨å¤„ç† `&[T]` å’Œ `&str` çš„åˆ†è§£
- Zig â†’ Cï¼šä½¿ç”¨ `[*c]` æŒ‡é’ˆç±»å‹ä¸ C äº¤äº’

### 3. **æ€§èƒ½ä¼˜åŒ–**
- é›¶æ‹·è´ï¼šåˆ‡ç‰‡å’Œå­—ç¬¦ä¸²é€šè¿‡æŒ‡é’ˆä¼ é€’
- å†…è”ä¼˜åŒ–ï¼šZig ç¼–è¯‘å™¨å¯ä»¥å†…è” C å‡½æ•°è°ƒç”¨
- å¢é‡ç¼–è¯‘ï¼šåªé‡æ–°ç¼–è¯‘ä¿®æ”¹çš„æ–‡ä»¶

### 4. **é”™è¯¯å¤„ç†**
- ç©ºæŒ‡é’ˆæ£€æŸ¥ï¼š`if (arr_ptr == null) return 0;`
- é•¿åº¦éªŒè¯ï¼š`if (arr_len == 0) return 0;`
- ç±»å‹è½¬æ¢ï¼š`@intCast()` å®‰å…¨è½¬æ¢

## ğŸ“ å­¦ä¹ ä»·å€¼

æœ¬ç¤ºä¾‹å±•ç¤ºäº†ï¼š

1. **å¤šè¯­è¨€æ··åˆç¼–ç¨‹**ï¼šRust + Zig + C æ— ç¼åä½œ
2. **FFI æœ€ä½³å®è·µ**ï¼šç±»å‹å®‰å…¨çš„è·¨è¯­è¨€è°ƒç”¨
3. **æ™ºèƒ½é™çº§æœºåˆ¶**ï¼šè‡ªåŠ¨å¤„ç†å¤æ‚ç±»å‹è½¬æ¢
4. **æ„å»ºç³»ç»Ÿé›†æˆ**ï¼šä¸€ä¸ª `build.rs` ç®¡ç†å¤šç§è¯­è¨€
5. **æ€§èƒ½ä¸å®‰å…¨çš„å¹³è¡¡**ï¼šé›¶æˆæœ¬æŠ½è±¡ + ç±»å‹å®‰å…¨

## ğŸ”— ç›¸å…³ç¤ºä¾‹

- [`examples/external`](../external/) - å¤–éƒ¨ .zig æ–‡ä»¶æ”¯æŒ
- [`examples/smart_lowering`](../smart_lowering/) - æ™ºèƒ½é™çº§è¯¦ç»†æ¼”ç¤º
- [`examples/structs`](../structs/) - ç»“æ„ä½“ç±»å‹æ”¯æŒ

## ğŸ“– æ‰©å±•é˜…è¯»

- [autozig æ–‡æ¡£](../../README.md)
- [Zig C äº’æ“ä½œæŒ‡å—](https://ziglang.org/documentation/master/#C)
- [Rust FFI æŒ‡å—](https://doc.rust-lang.org/nomicon/ffi.html)