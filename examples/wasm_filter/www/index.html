<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoZig WASM æ€§èƒ½å¯¹æ¯” Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: url('logofull.png') center/cover no-repeat fixed;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            text-align: center;
            padding: 40px;
            border: 3px dashed #667eea;
            border-radius: 10px;
            background: #f8f9ff;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: translateY(-2px);
        }

        .upload-section.dragover {
            border-color: #764ba2;
            background: #e8ebff;
        }

        #fileInput {
            display: none;
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .canvas-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .canvas-wrapper {
            text-align: center;
        }

        .canvas-wrapper h3 {
            margin-bottom: 10px;
            color: #667eea;
        }

        canvas {
            max-width: 100%;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .implementation-selector {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .implementation-selector h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .impl-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .impl-btn {
            padding: 10px 25px;
            font-size: 14px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .impl-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .impl-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .controls {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .controls h3 {
            margin-bottom: 20px;
            color: #667eea;
            text-align: center;
        }

        .filter-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .filter-btn:active {
            transform: translateY(0);
        }

        .brightness-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }

        .brightness-control label {
            font-weight: bold;
            color: #667eea;
        }

        .brightness-control input[type="range"] {
            flex: 1;
            max-width: 300px;
        }

        .brightness-control span {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #764ba2;
        }

        .performance-comparison {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .performance-comparison h3 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            overflow: hidden;
            border-radius: 8px;
        }

        .comparison-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #e8ebff;
        }

        .comparison-table tbody tr:hover {
            background: #f8f9ff;
        }

        .speedup {
            font-weight: bold;
            color: #28a745;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .canvas-container {
                grid-template-columns: 1fr;
            }

            .impl-buttons {
                flex-direction: column;
            }

            .filter-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ AutoZig WASM æ€§èƒ½å¯¹æ¯”</h1>
            <p>å¯¹æ¯” AutoZig (Zig) vs Rust Native vs JavaScript Native</p>
        </div>

        <div class="content">
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">ğŸ“</div>
                <h2>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</h2>
                <p style="margin-top: 10px; color: #666;">æ”¯æŒ JPG, PNG, GIF ç­‰æ ¼å¼</p>
                <input type="file" id="fileInput" accept="image/*">
            </div>

            <div id="editorSection" class="hidden">
                <div class="implementation-selector">
                    <h3>ğŸ”§ é€‰æ‹©å®ç°æ–¹å¼</h3>
                    <div class="impl-buttons">
                        <button class="impl-btn active" data-impl="autozig">âš¡ AutoZig (Zig)</button>
                        <button class="impl-btn" data-impl="rust">ğŸ¦€ Rust Native</button>
                        <button class="impl-btn" data-impl="js">ğŸŸ¨ JavaScript</button>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        å½“å‰ä½¿ç”¨ï¼š<span id="currentImpl" style="color: #667eea; font-weight: bold;">AutoZig (Zig)</span>
                    </p>
                </div>

                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <h3>ğŸ“· åŸå§‹å›¾åƒ</h3>
                        <canvas id="originalCanvas"></canvas>
                    </div>
                    <div class="canvas-wrapper">
                        <h3>âœ¨ å¤„ç†åå›¾åƒ</h3>
                        <canvas id="filteredCanvas"></canvas>
                    </div>
                </div>

                <div class="controls">
                    <h3>ğŸ›ï¸ æ»¤é•œæ§åˆ¶</h3>
                    <div class="filter-buttons">
                        <button class="filter-btn" onclick="applyInvert()">ğŸ”„ åè‰²</button>
                        <button class="filter-btn" onclick="applyGrayscale()">âš« ç°åº¦</button>
                    </div>
                    <div class="brightness-control">
                        <label>â˜€ï¸ äº®åº¦è°ƒæ•´ï¼ˆå®æ—¶ï¼‰:</label>
                        <input type="range" id="brightnessSlider" min="-100" max="100" value="0" step="1">
                        <span id="brightnessValue">0</span>
                    </div>
                </div>

                <div class="performance-comparison">
                    <h3>ğŸ“Š æ€§èƒ½å¯¹æ¯”</h3>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>å®ç°æ–¹å¼</th>
                                <th>å¤„ç†æ—¶é—´</th>
                                <th>ååé‡</th>
                                <th>ç›¸å¯¹æ€§èƒ½</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>âš¡ AutoZig (Zig)</strong></td>
                                <td id="time-autozig">-</td>
                                <td id="throughput-autozig">-</td>
                                <td id="speedup-autozig">åŸºå‡†</td>
                            </tr>
                            <tr>
                                <td><strong>ğŸ¦€ Rust Native</strong></td>
                                <td id="time-rust">-</td>
                                <td id="throughput-rust">-</td>
                                <td id="speedup-rust">-</td>
                            </tr>
                            <tr>
                                <td><strong>ğŸŸ¨ JavaScript</strong></td>
                                <td id="time-js">-</td>
                                <td id="throughput-js">-</td>
                                <td id="speedup-js">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import init, { 
            apply_invert, apply_grayscale, apply_brightness,
            apply_invert_rust, apply_grayscale_rust, apply_brightness_rust
        } from './pkg/autozig_wasm_filter.js';

        let originalImageData = null;
        let currentImageData = null;
        let currentImplementation = 'autozig';
        
        // æ€§èƒ½ç»Ÿè®¡
        let perfStats = {
            autozig: { time: 0, count: 0 },
            rust: { time: 0, count: 0 },
            js: { time: 0, count: 0 }
        };

        // åˆå§‹åŒ– WASM
        await init();
        console.log('âœ… WASM æ¨¡å—åŠ è½½æˆåŠŸ');

        // ============================================================================
        // JavaScript Native å®ç°
        // ============================================================================

        function apply_invert_js(data) {
            const result = new Uint8Array(data.length);
            for (let i = 0; i < data.length; i += 4) {
                result[i] = 255 - data[i];         // R
                result[i + 1] = 255 - data[i + 1]; // G
                result[i + 2] = 255 - data[i + 2]; // B
                result[i + 3] = data[i + 3];       // A
            }
            return result;
        }

        function apply_grayscale_js(data) {
            const result = new Uint8Array(data.length);
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const gray = Math.floor((r * 299 + g * 587 + b * 114) / 1000);
                result[i] = gray;
                result[i + 1] = gray;
                result[i + 2] = gray;
                result[i + 3] = data[i + 3];
            }
            return result;
        }

        function apply_brightness_js(data, delta) {
            const result = new Uint8Array(data.length);
            for (let i = 0; i < data.length; i += 4) {
                result[i] = Math.max(0, Math.min(255, data[i] + delta));
                result[i + 1] = Math.max(0, Math.min(255, data[i + 1] + delta));
                result[i + 2] = Math.max(0, Math.min(255, data[i + 2] + delta));
                result[i + 3] = data[i + 3];
            }
            return result;
        }

        // ============================================================================
        // å®ç°åˆ‡æ¢
        // ============================================================================

        document.querySelectorAll('.impl-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.impl-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentImplementation = this.dataset.impl;
                
                const implNames = {
                    autozig: 'AutoZig (Zig)',
                    rust: 'Rust Native',
                    js: 'JavaScript'
                };
                document.getElementById('currentImpl').textContent = implNames[currentImplementation];
            });
        });

        // ============================================================================
        // æ–‡ä»¶ä¸Šä¼ 
        // ============================================================================

        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const editorSection = document.getElementById('editorSection');

        uploadSection.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                loadImage(e.target.files[0]);
            }
        });

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                loadImage(e.dataTransfer.files[0]);
            }
        });

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const originalCanvas = document.getElementById('originalCanvas');
                    const filteredCanvas = document.getElementById('filteredCanvas');

                    originalCanvas.width = filteredCanvas.width = img.width;
                    originalCanvas.height = filteredCanvas.height = img.height;

                    const ctx = originalCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    originalImageData = ctx.getImageData(0, 0, img.width, img.height);
                    currentImageData = ctx.getImageData(0, 0, img.width, img.height);

                    uploadSection.classList.add('hidden');
                    editorSection.classList.remove('hidden');

                    const filteredCtx = filteredCanvas.getContext('2d');
                    filteredCtx.putImageData(currentImageData, 0, 0);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ============================================================================
        // æ€§èƒ½ç»Ÿè®¡æ›´æ–°
        // ============================================================================

        function updatePerfStats(impl, duration, dataSize) {
            perfStats[impl].time = duration;
            perfStats[impl].count++;
            
            const throughput = (dataSize / 1024 / 1024) / (duration / 1000);
            
            document.getElementById(`time-${impl}`).textContent = duration.toFixed(2) + ' ms';
            document.getElementById(`throughput-${impl}`).textContent = throughput.toFixed(2) + ' MB/s';
            
            // è®¡ç®—ç›¸å¯¹æ€§èƒ½
            if (perfStats.autozig.time > 0) {
                const autozig_time = perfStats.autozig.time;
                
                if (impl === 'autozig') {
                    document.getElementById('speedup-autozig').textContent = 'åŸºå‡† (1.00x)';
                } else if (perfStats[impl].time > 0) {
                    const speedup = (perfStats[impl].time / autozig_time).toFixed(2);
                    document.getElementById(`speedup-${impl}`).innerHTML = 
                        `<span class="speedup">${speedup}x æ…¢</span>`;
                }
            }
        }

        // ============================================================================
        // æ»¤é•œåº”ç”¨
        // ============================================================================

        function applyFilter(filterFn) {
            if (!originalImageData) return;

            const data = new Uint8Array(originalImageData.data);
            const startTime = performance.now();
            
            let result;
            if (currentImplementation === 'autozig') {
                result = filterFn.autozig(data);
            } else if (currentImplementation === 'rust') {
                result = filterFn.rust(data);
            } else {
                result = filterFn.js(data);
            }
            
            const endTime = performance.now();
            const duration = endTime - startTime;

            currentImageData.data.set(result);
            const filteredCanvas = document.getElementById('filteredCanvas');
            const ctx = filteredCanvas.getContext('2d');
            ctx.putImageData(currentImageData, 0, 0);

            updatePerfStats(currentImplementation, duration, result.length);

            document.getElementById('brightnessSlider').value = 0;
            document.getElementById('brightnessValue').textContent = '0';
        }

        window.applyInvert = function() {
            applyFilter({
                autozig: apply_invert,
                rust: apply_invert_rust,
                js: apply_invert_js
            });
        };

        window.applyGrayscale = function() {
            applyFilter({
                autozig: apply_grayscale,
                rust: apply_grayscale_rust,
                js: apply_grayscale_js
            });
        };

        // äº®åº¦æ»‘å—å®æ—¶æ›´æ–°
        document.getElementById('brightnessSlider').addEventListener('input', function(e) {
            const value = e.target.value;
            document.getElementById('brightnessValue').textContent = value;
            
            if (!originalImageData) return;
            
            const delta = parseInt(value);
            const data = new Uint8Array(originalImageData.data);
            const startTime = performance.now();
            
            let result;
            if (currentImplementation === 'autozig') {
                result = apply_brightness(data, delta);
            } else if (currentImplementation === 'rust') {
                result = apply_brightness_rust(data, delta);
            } else {
                result = apply_brightness_js(data, delta);
            }
            
            const endTime = performance.now();
            const duration = endTime - startTime;
            
            currentImageData.data.set(result);
            const filteredCanvas = document.getElementById('filteredCanvas');
            const ctx = filteredCanvas.getContext('2d');
            ctx.putImageData(currentImageData, 0, 0);
            
            updatePerfStats(currentImplementation, duration, result.length);
        });
    </script>
</body>
</html> 
delta = parseInt(value);
            const data = new Uint8Array(originalImageData.data);
            const startTime = performance.now();
            
            let result;
            if (currentImplementation === 'autozig') {
                result = apply_brightness(data, delta);
            } else if (currentImplementation === 'rust') {
                result = apply_brightness_rust(data, delta);
            } else {
                result = apply_brightness_js(data, delta);
            }
            
            const endTime = performance.now();
            const duration = endTime - startTime;
            
            currentImageData.data.set(result);
            const filteredCanvas = document.getElementById('filteredCanvas');
            const ctx = filteredCanvas.getContext('2d');
            ctx.putImageData(currentImageData, 0, 0);
            
            updatePerfStats(currentImplementation, duration, result.length);
        });
    </script>
</body>
</html>